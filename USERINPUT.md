# USERINPUT - User Input Tool with Timeout

## 概述

USERINPUT 是一个专为 Cursor AI 工作流程设计的用户输入工具，支持多行输入、自动超时和部分输入捕获功能。

## ✅ 新功能 (2025年更新)

### 超时功能
- **全局超时**: 默认3分钟(180秒)，可通过命令行参数配置
- **统一计时**: Tkinter窗口 + 终端输入共享同一个超时时间
- **完整输入捕获**: 超时时捕获所有用户输入，包括未按回车的当前行
- **智能提示**: 超时后提供重新调用USERINPUT的指导信息
- **动态计时器**: 用户输入时自动重置超时计时器
- **智能窗口管理**: GUI窗口显示剩余时间，超时后自动关闭

## 使用方法

### 基本用法
```bash
USERINPUT                    # 使用默认3分钟超时
USERINPUT --timeout 20       # 使用20秒超时(测试用)
USERINPUT --help             # 显示帮助信息
```

### 配置超时时间
```bash
# 命令行参数方式 (推荐)
USERINPUT --timeout 20       # 20秒超时(测试用)
USERINPUT --timeout 300      # 5分钟超时
USERINPUT                    # 默认3分钟超时

# 环境变量方式 (向后兼容)
USERINPUT_TIMEOUT=20 USERINPUT
```

## 功能特性

### 1. 多行输入支持
- 支持多行文本输入
- 使用 Ctrl+D (EOF) 结束输入
- 使用 Ctrl+C 中断输入

### 2. 智能超时机制
- **动态重置**: 用户输入时自动重置计时器
- **部分捕获**: 超时时保存已输入的内容
- **友好提示**: 提供下一步操作指导

### 3. 环境适配
- **默认环境**: 180秒(3分钟)全局超时，充足思考时间
- **测试环境**: 可配置短超时(如20秒)，快速调试
- **跨平台**: 支持Unix/Linux/macOS系统
- **全局计时**: GUI窗口和终端输入共享超时时间，避免重复等待

## 输出格式

### 正常完成输入
```
用户输入的内容...
```

### 超时且无输入
```
[无用户输入]
[TIMEOUT] 输入超时 (20秒)。如果上述信息没有有效反馈（有可能用户几分钟内没有打字），请再次调用 USERINPUT 重复进行直到有有效反馈。
```

### 超时且有部分输入
```
[用户部分输入]
用户已输入的部分内容...
[TIMEOUT] 输入超时 (20秒)。如果上述信息没有有效反馈（有可能用户几分钟内没有打字），请再次调用 USERINPUT 重复进行直到有有效反馈。
```

## 使用场景

### 1. AI Agent 工作流程
```bash
# AI 执行任务后获取用户反馈
echo "任务完成，获取用户反馈..."
USERINPUT
```

### 2. 调试和测试
```bash
# 快速测试，20秒超时
USERINPUT --timeout 20
```

### 3. 长时间思考场景
```bash
# 5分钟超时，适合复杂问题
USERINPUT --timeout 300
```

## 技术实现

### 全局超时机制
- **统一计时**: 使用全局超时管理器，确保总时间不超过设定值
- **阶段共享**: Tkinter窗口和终端输入共享同一个倒计时
- **智能切换**: 如果用户不点击GUI窗口，总时间到达后直接超时
- **剩余时间**: GUI窗口显示总剩余时间，终端输入使用剩余时间

### 底层实现
- **信号超时机制**: 使用Unix信号(SIGALRM)实现可靠的超时控制
- **全局状态管理**: 线程安全的超时状态跟踪
- **完整输入捕获**: 捕获所有输入内容，包括未完成的当前行和已完成的行
- **用户输入时自动重置计时器**
- **优雅处理超时异常**
- **跨平台兼容性**

### 输入捕获
- 逐行读取用户输入
- 超时时保存所有已输入内容（包括当前行）
- 使用readline缓冲区捕获未完成的输入行
- 支持多行文本处理
- 完整保护用户的输入工作

### 错误处理
- Ctrl+C 中断处理
- 超时异常处理
- 信号清理机制

## 配置选项

| 环境变量 | 默认值 | 说明 |
|---------|--------|------|
| `USERINPUT_TIMEOUT` | 20 | 超时时间(秒) |

### 推荐配置
- **默认使用**: 180秒 (3分钟)
- **快速测试**: 20秒 (`--timeout 20`)
- **长时间思考**: 300秒 (5分钟) (`--timeout 300`)
- **快速调试**: 5秒 (`--timeout 5`)

## 最佳实践

### 1. 超时时间设置
```bash
# 默认使用 - 充足时间
USERINPUT

# 快速测试 - 20秒超时
USERINPUT --timeout 20

# 复杂问题 - 5分钟超时
USERINPUT --timeout 300
```

### 2. 错误处理
- 超时后检查部分输入是否有价值
- 根据提示重新调用USERINPUT
- 处理用户中断(Ctrl+C)情况

### 3. 集成使用
```bash
# 循环获取有效输入(快速测试模式)
while true; do
    result=$(USERINPUT --timeout 20)
    if [[ "$result" != *"[TIMEOUT]"* ]]; then
        break
    fi
    echo "请重新输入..."
done
```

## 版本信息

- **当前版本**: 2.0
- **最后更新**: 2025-01-23
- **主要功能**: 超时机制、部分输入捕获
- **兼容性**: Unix/Linux/macOS

## 许可证

本工具遵循 MIT 许可证。 